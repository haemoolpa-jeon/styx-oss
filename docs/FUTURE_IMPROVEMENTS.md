# Styx 향후 개선 계획

> 추후 검토할 수 있는 성능/안정성 개선 옵션들

---

## 현재 구현 상태 (v1.0)

### 완료된 최적화
- ✅ Opus 코덱 최적화 (FEC, DTX, 비트레이트)
- ✅ 오디오 입력 최적화 (48kHz, 모노, 저지연)
- ✅ 적응형 비트레이트 (패킷 손실 + 지터 기반)
- ✅ ICE 연결 최적화 (STUN 3개, TURN 3개)
- ✅ AudioContext 저지연 설정
- ✅ 네트워크 변경 감지 및 자동 재연결
- ✅ 지연 보상 모드 (합주용)
- ✅ Perfect Negotiation (WebRTC glare 처리)

---

## 향후 개선 옵션

### 1. 자체 TURN 서버 구축

**현재 상황**
- 무료 OpenRelay TURN 서버 사용 중
- 무료 서버는 안정성/속도 보장 없음

**개선 방안**
- Coturn 오픈소스 TURN 서버 직접 운영
- 또는 Twilio/Xirsys 등 유료 서비스 사용

**예상 비용**
- 자체 운영: 월 $5~20 (별도 서버 필요)
- Twilio: 사용량 기반 과금 (GB당 $0.40~)
- Xirsys: 월 $50~ (무제한 플랜)

**구현 난이도**: 중간 (1~2일)

**기대 효과**
- NAT/방화벽 환경에서 연결 성공률 향상
- 릴레이 연결 시 지연 시간 감소
- 서비스 안정성 향상

**참고 자료**
- Coturn: https://github.com/coturn/coturn
- Twilio TURN: https://www.twilio.com/stun-turn

---

### 2. 오디오 워크렛 (Audio Worklet)

**현재 상황**
- 메인 스레드에서 오디오 처리
- CPU 부하 시 오디오 끊김 가능

**개선 방안**
- AudioWorkletProcessor로 별도 스레드에서 처리
- 메인 스레드 부하와 오디오 분리

**예상 비용**: 없음 (코드 변경만)

**구현 난이도**: 어려움 (3~5일)

**기대 효과**
- CPU 부하 상황에서 오디오 안정성 향상
- 복잡한 오디오 처리 가능 (이펙트 등)

**주의사항**
- Safari 지원 제한적
- 디버깅 어려움
- 기존 코드 대폭 수정 필요

**참고 자료**
- MDN Audio Worklet: https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet
- Google 예제: https://googlechromelabs.github.io/web-audio-samples/audio-worklet/

---

### 3. WebTransport

**현재 상황**
- WebRTC 사용 (UDP 기반 P2P)
- 시그널링 오버헤드 존재

**개선 방안**
- WebTransport API로 직접 UDP 통신
- QUIC 프로토콜 기반 저지연 전송

**예상 비용**: 없음 (코드 변경만)

**구현 난이도**: 매우 어려움 (1~2주)

**기대 효과**
- WebRTC보다 낮은 지연 가능
- 더 세밀한 전송 제어

**주의사항**
- 2024년 기준 실험적 기능
- Chrome만 지원 (Firefox, Safari 미지원)
- 서버 측 구현 필요 (HTTP/3)
- P2P 불가, 서버 경유 필수

**권장 시기**: 브라우저 지원 확대 후 (2025년 이후)

**참고 자료**
- WebTransport: https://web.dev/webtransport/
- W3C 스펙: https://w3c.github.io/webtransport/

---

### 4. SFU (Selective Forwarding Unit)

**현재 상황**
- Full Mesh P2P 구조
- N명 연결 시 각 클라이언트가 N-1개 연결 유지
- 3명 이상에서 대역폭 급증

**개선 방안**
- 중앙 SFU 서버 도입
- 클라이언트는 서버와 1개 연결만 유지
- 서버가 미디어 선택적 전달

**예상 비용**
- mediasoup/Janus 자체 운영: 월 $20~50 (고사양 서버 필요)
- Daily.co/Vonage 등 SaaS: 분당 $0.004~

**구현 난이도**: 매우 어려움 (2~4주)

**기대 효과**
- 다인원(4명+) 방에서 대역폭 효율 향상
- 클라이언트 CPU 부하 감소
- 녹화/스트리밍 기능 추가 용이

**주의사항**
- 서버 비용 증가
- 아키텍처 전면 변경 필요
- 서버 장애 시 전체 영향

**참고 자료**
- mediasoup: https://mediasoup.org/
- Janus: https://janus.conf.meetecho.com/
- LiveKit: https://livekit.io/

---

### 5. 오디오 품질 프리셋

**현재 상황**
- 음성/음악 2가지 모드만 존재
- 세부 설정은 개별 조절 필요

**개선 방안**
- 사용자 친화적 프리셋 추가
- 상황별 최적 설정 자동 적용

**예상 비용**: 없음

**구현 난이도**: 쉬움 (2~4시간)

**프리셋 예시**
```
초저지연 모드:
- 버퍼: 50ms
- 비트레이트: 24kbps
- 에코/노이즈 제거: OFF
- 용도: 합주, 실시간 반응 필요

고음질 모드:
- 버퍼: 150ms
- 비트레이트: 128kbps
- 스테레오: ON
- 용도: 음악 감상, 녹음

안정성 우선:
- 버퍼: 200ms
- 비트레이트: 32kbps
- 자동 품질: ON
- 용도: 불안정한 네트워크
```

**기대 효과**
- 사용자 편의성 향상
- 상황별 최적 설정 쉽게 적용

---

## 우선순위 권장

| 순위 | 항목 | 비용 | 난이도 | 효과 | 권장 시기 |
|------|------|------|--------|------|----------|
| 1 | 오디오 프리셋 | 없음 | 쉬움 | 중간 | 즉시 가능 |
| 2 | 자체 TURN | 월 $5~20 | 중간 | 높음 | 사용자 증가 시 |
| 3 | 오디오 워크렛 | 없음 | 어려움 | 중간 | 끊김 이슈 발생 시 |
| 4 | SFU 전환 | 월 $20~50 | 매우 어려움 | 높음 | 4명+ 방 많아질 때 |
| 5 | WebTransport | 없음 | 매우 어려움 | 높음 | 2025년 이후 |

---

## 모니터링 지표

개선 필요성 판단을 위해 모니터링할 지표:

1. **연결 성공률**: TURN 필요성 판단
2. **평균 지연 시간**: 저지연 최적화 필요성
3. **패킷 손실률**: 네트워크 안정성
4. **동시 접속자 수**: SFU 전환 시점
5. **사용자 피드백**: 끊김, 음질 불만

---

## 결론

현재 v1.0은 소규모(2~4명) 음성 협업에 충분한 수준입니다.

**단기 (1~3개월)**
- 사용자 피드백 수집
- 오디오 프리셋 추가 고려

**중기 (3~6개월)**
- 사용자 증가 시 자체 TURN 서버 검토
- 연결 실패 사례 분석

**장기 (6개월+)**
- 다인원 지원 필요 시 SFU 검토
- 브라우저 기술 발전에 따라 WebTransport 검토

---

*문서 작성: 2024년 12월*
*다음 검토 예정: 2025년 3월*
