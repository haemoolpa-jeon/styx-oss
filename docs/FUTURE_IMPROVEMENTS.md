# Styx 향후 개선 계획

> 추후 검토할 수 있는 성능/안정성/기능 개선 옵션들

---

## 현재 구현 상태 (v1.1)

### 완료된 최적화
- ✅ Opus 코덱 최적화 (FEC, DTX, 비트레이트)
- ✅ 오디오 입력 최적화 (48kHz, 모노, 저지연)
- ✅ 적응형 비트레이트 (패킷 손실 + 지터 기반)
- ✅ ICE 연결 최적화 (STUN 3개, TURN 3개)
- ✅ AudioContext 저지연 설정
- ✅ 네트워크 변경 감지 및 자동 재연결
- ✅ 지연 보상 모드 (합주용)
- ✅ Perfect Negotiation (WebRTC glare 처리)

### 현재 기능
- ✅ WebRTC P2P 오디오 (웹)
- ✅ UDP 저지연 모드 (Tauri 앱)
- ✅ 메트로놈 동기화 (카운트인, 강박/약박 구분, 비트 표시)
- ✅ 음성/음악 모드
- ✅ 믹스 녹음
- ✅ 텍스트 채팅
- ✅ 방 관리 (생성/비밀번호/닫기)
- ✅ 개인 믹서 (뮤트/솔로/팬)

---

## 경쟁 제품 비교

| 기능 | Jamulus | JamKazam | SonoBus | Styx |
|------|---------|----------|---------|------|
| 지연 시간 | 10-20ms | 20-40ms | 15-30ms | 30-50ms |
| ASIO 지원 | ✅ | ✅ | ✅ | ✅ (Tauri) |
| 웹 버전 | ❌ | ❌ | ❌ | ✅ |
| 메트로놈 | ❌ | ✅ | ❌ | ✅ (강화됨) |
| 개인 믹서 | ✅ | ✅ | ✅ | ✅ |
| 멀티트랙 녹음 | 서버측 | ✅ | ✅ | ❌ |
| 오디오 이펙트 | ❌ | ❌ | ✅ | ❌ |
| 설치 필요 | ✅ | ✅ | ✅ | ❌ (웹) |

**Styx 강점**: 웹 브라우저로 즉시 사용 가능, 설치 불필요, 개인 믹서 지원
**Styx 약점**: 지연 시간 (WebRTC 한계)

---

## ✅ 완료된 기능 개선

### 1. 개인 믹서 강화 ✅ (v1.1 구현 완료)

**현재 상황**
- 각 참가자 볼륨만 조절 가능
**구현 완료** (2024-12-18)

```
각 참가자 카드:
┌─────────────────────────────┐
│  👤 사용자명                 │
│  [M] [S]  ◀──●──▶  🔊 80%  │
│   뮤트 솔로    팬     볼륨   │
└─────────────────────────────┘
```

- **뮤트(M)**: 해당 사용자 소리 끄기
- **솔로(S)**: 해당 사용자만 듣기 (다른 사람 자동 뮤트)
- **팬**: 좌(-100) ~ 우(+100) 스테레오 위치

**구현 내용**
- StereoPannerNode로 실시간 팬 조절
- applyMixerState() 함수로 뮤트/솔로 상태 관리
- 솔로 활성화 시 다른 모든 피어 자동 뮤트

---

### 2. 메트로놈 개선 (카운트인/강박 표시) ✅ (v1.1 구현 완료)

**구현 완료** (2024-12-18)

```
메트로놈 UI:
┌─────────────────────────────────────┐
│  ▶️  [120] BPM  [✓ 카운트인]        │
│     ①    ②    ③    ④              │
│     (비트 인디케이터)                │
└─────────────────────────────────────┘
```

**구현 내용**
- **카운트인**: 체크박스 선택 시 시작 전 4박 카운트
- **강박/약박**: 첫 박 1200Hz (높은 음), 나머지 800Hz (낮은 음)
- **비트 인디케이터**: 1-2-3-4 숫자로 현재 박자 표시
- **색상 구분**: 첫 박 녹색, 나머지 보라색

---

## 향후 기능 개선 (Feature Enhancements)

### 3. 세션 프리셋

**현재 상황**
- 음성/음악 2가지 모드만 존재
- 세부 설정(버퍼, 에코제거 등)은 개별 조절 필요
- 매번 설정 다시 해야 함

**개선 내용**
```
프리셋 선택 UI:
┌─────────────────────────────────────┐
│  프리셋: [▼ 합주 모드          ]    │
│                                     │
│  • 합주 모드 (저지연)               │
│  • 대화 모드 (안정성)               │
│  • 녹음 모드 (고음질)               │
│  • 사용자 정의...                   │
└─────────────────────────────────────┘
```

**프리셋 상세**

| 설정 | 합주 모드 | 대화 모드 | 녹음 모드 |
|------|----------|----------|----------|
| 버퍼 | 50ms | 150ms | 100ms |
| 비트레이트 | 64kbps | 32kbps | 128kbps |
| 에코 제거 | OFF | ON | OFF |
| 노이즈 제거 | OFF | ON | OFF |
| 지연 보상 | ON | OFF | ON |
| 자동 품질 | OFF | ON | OFF |

**구현 방법**
- 프리셋 객체 정의
- 선택 시 모든 설정 일괄 적용
- localStorage에 마지막 사용 프리셋 저장

**구현 난이도**: 쉬움 (2-3시간)
**예상 비용**: 없음

**기대 효과**
- 초보 사용자도 최적 설정 쉽게 적용
- 상황 전환 시 빠른 설정 변경
- 일관된 사용자 경험

**예상 결과물**
- UI: 프리셋 드롭다운 메뉴
- 기능: 원클릭 설정 변경

---

### 4. 멀티트랙 녹음

**현재 상황**
- 모든 참가자 소리가 믹스된 단일 파일만 저장
- 나중에 개별 조절 불가능

**개선 내용**
```
녹음 옵션:
┌─────────────────────────────────────┐
│  녹음 모드:                         │
│  ○ 믹스 (단일 파일)                 │
│  ● 멀티트랙 (참가자별 파일)         │
│                                     │
│  [⏺️ 녹음 시작]                     │
└─────────────────────────────────────┘

결과물:
📁 styx-recording-2024-12-18/
├── mix.webm (전체 믹스)
├── user1.webm (사용자1)
├── user2.webm (사용자2)
└── user3.webm (사용자3)
```

**구현 방법**
- 각 피어의 오디오 스트림을 개별 MediaRecorder로 녹음
- 녹음 종료 시 ZIP 파일로 묶어서 다운로드
- 또는 개별 파일 순차 다운로드

**구현 난이도**: 중간 (4-6시간)
**예상 비용**: 없음

**기대 효과**
- 녹음 후 DAW에서 개별 트랙 편집 가능
- 특정 참가자 볼륨 조절, 이펙트 적용 가능
- 전문적인 녹음 결과물 생성

**예상 결과물**
- UI: 녹음 모드 선택 라디오 버튼
- 기능: 참가자별 개별 오디오 파일 생성

---

### 5. 오디오 이펙트

**현재 상황**
- 압축기(Compressor)만 적용 중
- 리버브, EQ 등 이펙트 없음

**개선 내용**
```
이펙트 패널:
┌─────────────────────────────────────┐
│  내 오디오 이펙트                    │
│                                     │
│  리버브: [──●────] 30%              │
│  EQ 저음: [────●──] +3dB            │
│  EQ 고음: [──●────] -2dB            │
│  노이즈 게이트: [ON]                 │
└─────────────────────────────────────┘
```

**이펙트 상세**
- **리버브**: ConvolverNode로 공간감 추가
- **EQ**: BiquadFilterNode로 주파수 조절
- **노이즈 게이트**: 일정 레벨 이하 소리 차단

**구현 방법**
- Web Audio API 노드 체인에 이펙트 추가
- 실시간 파라미터 조절
- 프리셋 저장 가능

**구현 난이도**: 중간 (6-8시간)
**예상 비용**: 없음

**기대 효과**
- 마이크 음질 개선
- 방 울림 추가로 자연스러운 소리
- 배경 소음 제거

**예상 결과물**
- UI: 이펙트 슬라이더 패널
- 오디오: 실시간 이펙트 적용

---

### 6. 연결 품질 상세 표시

**현재 상황**
- 좋음/보통/불안정 3단계만 표시
- 지연 시간, 손실률 숫자만 표시

**개선 내용**
```
상세 연결 정보 패널:
┌─────────────────────────────────────┐
│  연결 상태 상세                      │
│                                     │
│  연결 방식: P2P (직접 연결)          │
│  코덱: Opus 48kHz                   │
│  비트레이트: 64 kbps                │
│                                     │
│  지연 시간 (최근 30초):              │
│  ▁▂▃▂▁▂▃▄▃▂▁▂▃▂▁ 평균: 45ms        │
│                                     │
│  패킷 손실 (최근 1분):               │
│  ▁▁▁▂▁▁▁▁▃▁▁▁▁▁▁ 평균: 0.5%        │
└─────────────────────────────────────┘
```

**구현 방법**
- RTCPeerConnection.getStats()에서 상세 정보 추출
- 히스토리 데이터 저장 및 그래프 렌더링
- 연결 방식(P2P/TURN) 감지

**구현 난이도**: 쉬움 (2-3시간)
**예상 비용**: 없음

**기대 효과**
- 연결 문제 원인 파악 용이
- 네트워크 상태 추이 확인
- 기술 지원 시 정확한 정보 제공

**예상 결과물**
- UI: 상세 정보 모달 또는 패널
- 그래프: 실시간 지연/손실 히스토리

---

## 인프라 개선 (Infrastructure)

### 7. 자체 TURN 서버 구축

**현재 상황**
- 무료 OpenRelay TURN 서버 사용 중
- 무료 서버는 안정성/속도 보장 없음

**개선 방안**
- Coturn 오픈소스 TURN 서버 직접 운영
- 또는 Twilio/Xirsys 등 유료 서비스 사용

**예상 비용**
- 자체 운영: 월 $5~20 (별도 서버 필요)
- Twilio: 사용량 기반 과금 (GB당 $0.40~)
- Xirsys: 월 $50~ (무제한 플랜)

**구현 난이도**: 중간 (1~2일)

**기대 효과**
- NAT/방화벽 환경에서 연결 성공률 향상
- 릴레이 연결 시 지연 시간 감소
- 서비스 안정성 향상

**예상 결과물**
- 자체 TURN 서버 운영
- 연결 성공률 95% → 99%

**참고 자료**
- Coturn: https://github.com/coturn/coturn
- Twilio TURN: https://www.twilio.com/stun-turn

---

### 8. SFU (Selective Forwarding Unit)

**현재 상황**
- Full Mesh P2P 구조
- N명 연결 시 각 클라이언트가 N-1개 연결 유지
- 3명 이상에서 대역폭 급증

**개선 방안**
- 중앙 SFU 서버 도입
- 클라이언트는 서버와 1개 연결만 유지
- 서버가 미디어 선택적 전달

**예상 비용**
- mediasoup/Janus 자체 운영: 월 $20~50 (고사양 서버 필요)
- Daily.co/Vonage 등 SaaS: 분당 $0.004~

**구현 난이도**: 매우 어려움 (2~4주)

**기대 효과**
- 다인원(4명+) 방에서 대역폭 효율 향상
- 클라이언트 CPU 부하 감소
- 녹화/스트리밍 기능 추가 용이

**예상 결과물**
- 8명 방에서도 안정적인 연결
- 클라이언트 업로드 대역폭 1/N로 감소

**참고 자료**
- mediasoup: https://mediasoup.org/
- Janus: https://janus.conf.meetecho.com/
- LiveKit: https://livekit.io/

---

## 기술 개선 (Technical)

### 9. 오디오 워크렛 (Audio Worklet)

**현재 상황**
- 메인 스레드에서 오디오 처리
- CPU 부하 시 오디오 끊김 가능

**개선 방안**
- AudioWorkletProcessor로 별도 스레드에서 처리
- 메인 스레드 부하와 오디오 분리

**예상 비용**: 없음 (코드 변경만)

**구현 난이도**: 어려움 (3~5일)

**기대 효과**
- CPU 부하 상황에서 오디오 안정성 향상
- 복잡한 오디오 처리 가능 (이펙트 등)

**예상 결과물**
- 탭 전환, 다른 작업 중에도 오디오 끊김 없음

**주의사항**
- Safari 지원 제한적
- 디버깅 어려움
- 기존 코드 대폭 수정 필요

**참고 자료**
- MDN Audio Worklet: https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet

---

### 10. WebTransport

**현재 상황**
- WebRTC 사용 (UDP 기반 P2P)
- 시그널링 오버헤드 존재

**개선 방안**
- WebTransport API로 직접 UDP 통신
- QUIC 프로토콜 기반 저지연 전송

**예상 비용**: 없음 (코드 변경만)

**구현 난이도**: 매우 어려움 (1~2주)

**기대 효과**
- WebRTC보다 낮은 지연 가능
- 더 세밀한 전송 제어

**예상 결과물**
- 지연 시간 30-50ms → 20-30ms

**주의사항**
- 2024년 기준 실험적 기능
- Chrome만 지원 (Firefox, Safari 미지원)
- 서버 측 구현 필요 (HTTP/3)
- P2P 불가, 서버 경유 필수

**권장 시기**: 브라우저 지원 확대 후 (2025년 이후)

**참고 자료**
- WebTransport: https://web.dev/webtransport/
- W3C 스펙: https://w3c.github.io/webtransport/

---

## 우선순위 권장

### 즉시 구현 가능 (비용 없음, 1일 이내)

| 순위 | 항목 | 구현 시간 | 사용자 가치 |
|------|------|----------|------------|
| 1 | 개인 믹서 (팬/뮤트/솔로) | 2-3시간 | ⭐⭐⭐⭐⭐ |
| 2 | 메트로놈 개선 (카운트인) | 1-2시간 | ⭐⭐⭐⭐ |
| 3 | 세션 프리셋 | 2-3시간 | ⭐⭐⭐⭐ |
| 4 | 연결 품질 상세 표시 | 2-3시간 | ⭐⭐⭐ |

### 단기 구현 (비용 없음, 1주 이내)

| 순위 | 항목 | 구현 시간 | 사용자 가치 |
|------|------|----------|------------|
| 5 | 멀티트랙 녹음 | 4-6시간 | ⭐⭐⭐⭐⭐ |
| 6 | 오디오 이펙트 | 6-8시간 | ⭐⭐⭐ |

### 중장기 검토 (비용/복잡도 있음)

| 순위 | 항목 | 비용 | 권장 시기 |
|------|------|------|----------|
| 7 | 자체 TURN 서버 | 월 $5~20 | 사용자 증가 시 |
| 8 | SFU 전환 | 월 $20~50 | 4명+ 방 많아질 때 |
| 9 | 오디오 워크렛 | 없음 | 끊김 이슈 발생 시 |
| 10 | WebTransport | 없음 | 2025년 이후 |

---

## 모니터링 지표

개선 필요성 판단을 위해 모니터링할 지표:

1. **연결 성공률**: TURN 필요성 판단 (목표: 99%)
2. **평균 지연 시간**: 저지연 최적화 필요성 (목표: <50ms)
3. **패킷 손실률**: 네트워크 안정성 (목표: <1%)
4. **동시 접속자 수**: SFU 전환 시점 (기준: 4명+)
5. **사용자 피드백**: 끊김, 음질 불만

---

## 로드맵

### Phase 1: 기능 강화 (v1.1) ✅ 완료
- [x] 개인 믹서 (팬/뮤트/솔로) - StereoPannerNode 기반
- [x] 메트로놈 개선 - 카운트인, 악센트 비트, 시각적 표시
- [ ] 세션 프리셋

### Phase 2: 녹음 강화 (v1.2)
- [ ] 멀티트랙 녹음
- [x] 연결 품질 상세 표시 - 패킷 손실률, 지연 시간 UI

### Phase 3: 오디오 품질 (v1.3)
- [ ] 오디오 이펙트
- [ ] 오디오 워크렛 (선택적)

### Phase 4: 인프라 확장 (v2.0)
- [ ] 자체 TURN 서버
- [ ] SFU 전환 검토

---

*문서 작성: 2024년 12월*
*최종 업데이트: 2024년 12월 19일*
*다음 검토 예정: 2025년 3월*
